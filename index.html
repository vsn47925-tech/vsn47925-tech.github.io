<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caba√±as Villaitue Villarrica - Autoservicio Accesible</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS para OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        /* Estilos para el carrusel de fondo */
        .welcome-carousel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            z-index: 0;
        }
        
        .welcome-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 3s ease-in-out;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .welcome-slide.active {
            opacity: 1;
        }
        
        .welcome-slide::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
        }
        
        /* Estilos para el contenido central */
        .welcome-content {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1;
            text-align: center;
            padding: 20px;
            color: white;
        }

        /* Logo en la pantalla de bienvenida - AUMENTADO EN 40% */
        .welcome-logo-container {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 2;
            margin-bottom: 1.5rem; /* Espacio entre logo y t√≠tulo */
        }

        .welcome-logo {
            max-width: 392px; /* 280px + 40% = 392px */
            width: 80%;
            height: auto;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        /* Estilos para el carrusel de resultados */
        .carousel-container {
            position: relative;
            width: 100%;
            height: 400px;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .carousel-inner {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .carousel-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
            z-index: 1;
        }
        
        .carousel-slide.active {
            opacity: 1;
            z-index: 2;
        }
        
        .carousel-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        
        /* Estilos para im√°genes de respuesta-info */
        .info-image-container {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .info-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 10px;
        }
        
        .info-image-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            color: white;
            padding: 15px 20px;
            font-size: 14px;
            text-align: center;
        }
        
        /* Estilos para el mapa */
        .map-container {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        #villaitueMap {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            z-index: 10;
        }
        
        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 197, 253, 0.05) 100%);
            pointer-events: none;
            z-index: 20;
            border-radius: 8px;
        }
        
        .map-marker {
            background-color: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.4);
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .map-marker::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: white;
            border-radius: 50%;
        }
        
        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .carousel-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #cbd5e1;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .carousel-dot.active {
            background-color: #3b82f6;
            transform: scale(1.2);
            border-color: #1d4ed8;
        }
        
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
            z-index: 3;
        }
        
        .carousel-btn:hover,
        .carousel-btn:focus {
            background-color: rgba(0, 0, 0, 0.7);
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
        .carousel-prev {
            left: 15px;
        }
        
        .carousel-next {
            right: 15px;
        }
        
        /* Animaci√≥n para mostrar respuesta */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Bot√≥n de micr√≥fono - accesible */
        .voice-btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            border: none;
            cursor: pointer;
        }
        
        .voice-btn:hover,
        .voice-btn:focus {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.6);
            outline: 2px solid #3b82f6;
            outline-offset: 4px;
        }
        
        .voice-btn.listening {
            background-color: #dc2626;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        
        /* Contenedor de respuesta */
        .response-container {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }

        /* Indicador de procesamiento accesible */
        #processingIndicator {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .processing-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-text {
            font-size: 1.5rem;
            max-width: 80%;
            line-height: 1.4;
        }

        .processing-message {
            display: none;
        }

        /* Regi√≥n viva para lectores de pantalla */
        #sr-only-region {
            position: absolute;
            left: -10000px;
            top: auto;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        /* Enfoque visible para navegaci√≥n por teclado */
        *:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* Evitar scroll en kiosco */
        body {
            overflow: hidden;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100">
    <!-- Regi√≥n oculta para anuncios a lectores de pantalla -->
    <div id="sr-only-region" aria-live="polite" aria-atomic="true"></div>

    <!-- Carrusel de fondo fullscreen -->
    <div class="welcome-carousel" role="presentation" aria-hidden="true">
        <div class="welcome-slide active" style="background-image: url('https://vsn47925-tech.github.io/img/cab-amanecervilla.jpg')"></div>
        <div class="welcome-slide" style="background-image: url('https://vsn47925-tech.github.io/img/volcan-entre-arboles.jpg')"></div>
        <div class="welcome-slide" style="background-image: url('https://vsn47925-tech.github.io/img/jardin-manzano-mesa.jpg')"></div>
        <div class="welcome-slide" style="background-image: url('https://vsn47925-tech.github.io/img/cab-entrada.jpg')"></div>
    </div>

    <!-- Contenido de bienvenida -->
    <div id="welcomeScreen" class="welcome-content" role="main">
        <!-- ‚úÖ LOGO NEGRO CENTRADO Y AUMENTADO EN 40% -->
        <div class="welcome-logo-container">
            <img 
                src="https://vsn47925-tech.github.io/img/logo_blanco.png" 
                alt="Logo de Caba√±as Villaitue" 
                class="welcome-logo"
                loading="eager"
            />
        </div>
        
        <!-- ‚úÖ T√çTULOS SIN M√ÅRGENES EXCESIVOS Y TOTALMENTE CENTRADOS -->
        <p class="text-lg md:text-xl mt-6 mb-8 max-w-2xl">
            Sistema Autoconsultas por voz. 
            <span class="sr-only">Presione el bot√≥n del micr√≥fono para comenzar.</span>
        </p>
        
        <!-- Bot√≥n para activar micr√≥fono -->
        <button 
            id="startVoiceBtn" 
            class="voice-btn bg-blue-600 hover:bg-blue-700 text-white p-5 rounded-full shadow-2xl text-3xl"
            aria-label="Iniciar consulta por voz"
        >
            <i class="fas fa-microphone" aria-hidden="true"></i>
        </button>
        
        <p class="mt-6 text-lg">
            <span class="sr-only">Instrucci√≥n: </span>Haz clic en el micr√≥fono para comenzar
        </p>
    </div>

    <!-- Contenedor de respuesta -->
    <div id="responseWrapper" class="hidden min-h-screen flex items-center justify-center p-4" role="region" aria-label="Respuesta del sistema">
        <div class="response-container">
            <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8">
                <!-- Bot√≥n de control de voz -->
                <div class="flex justify-end mb-6">
                    <button 
                        id="voiceControlBtn" 
                        class="voice-btn bg-blue-600 text-white p-3 rounded-full shadow-lg text-xl"
                        aria-label="Activar micr√≥fono para nueva consulta"
                    >
                        <i id="voiceIcon" class="fas fa-microphone" aria-hidden="true"></i>
                    </button>
                </div>
                
                <!-- Respuesta del agente -->
                <div id="agentResponse" class="w-full">
                    <h2 id="descripcionTitle" class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6" role="heading" aria-level="2"></h2>
                    
                    <!-- Carrusel de im√°genes -->
                    <div id="carouselContainer" class="hidden" role="region" aria-label="Galer√≠a de im√°genes">
                        <div class="carousel-container">
                            <div class="carousel-inner" role="group" aria-label="Im√°genes de la caba√±a">
                                <!-- Las slides se insertar√°n aqu√≠ din√°micamente -->
                            </div>
                        </div>
                        <div class="carousel-dots" role="tablist" aria-label="Navegaci√≥n de galer√≠a">
                            <!-- Los puntos se insertar√°n aqu√≠ din√°micamente -->
                        </div>
                    </div>
                    
                    <!-- Contenedor para imagen de respuesta-info -->
                    <div id="infoImageContainer" class="hidden" role="region" aria-label="Infograf√≠a informativa">
                        <div class="info-image-container">
                            <img id="infoImage" class="info-image" src="" alt="" />
                            <div id="infoImageCaption" class="info-image-caption" role="note"></div>
                        </div>
                    </div>
                    
                    <!-- Contenedor para mapa -->
                    <div id="mapContainer" class="hidden" role="region" aria-label="Ubicaci√≥n en el mapa">
                        <div class="map-container">
                            <div id="villaitueMap" aria-label="Mapa interactivo de OpenStreetMap"></div>
                            <div class="map-overlay" aria-hidden="true"></div>
                        </div>
                        <div class="text-center mt-3">
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-map-marker-alt text-red-500 mr-1" aria-hidden="true"></i>
                                Ubicaci√≥n: Caba√±as Villaitue, Villarrica, Chile
                            </p>
                            <p class="text-xs text-gray-500 mt-1">
                                Coordenadas: -39.2852346, -72.2227348
                            </p>
                        </div>
                    </div>
                    
                    <!-- Texto de respuesta -->
                    <div id="outputText" class="mt-8 p-5 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-volume-up text-blue-600 mr-2" aria-hidden="true"></i>
                            <h3 class="font-semibold text-blue-800">Respuesta del sistema:</h3>
                        </div>
                        <p id="outputContent" class="text-gray-700 text-lg" role="status" aria-live="polite"></p>
                    </div>
                    
                    <!-- Bot√≥n para nueva consulta -->
                    <div class="mt-8 text-center">
                        <button 
                            id="newQueryBtn" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium"
                            aria-label="Hacer una nueva consulta por voz"
                        >
                            <i class="fas fa-microphone mr-2" aria-hidden="true"></i>Nueva consulta
                        </button>
                    </div>
                </div>
                
                <!-- Estado de error -->
                <div id="errorState" class="hidden text-center p-8" role="alert" aria-live="assertive">
                    <div class="text-red-400 mb-6" aria-hidden="true">
                        <i class="fas fa-exclamation-triangle text-6xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Error en el sistema</h3>
                    <p id="errorMessage" class="text-gray-500"></p>
                    <button 
                        id="retryBtn" 
                        class="mt-6 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium"
                        aria-label="Reintentar la √∫ltima acci√≥n"
                    >
                        <i class="fas fa-redo mr-2" aria-hidden="true"></i>Reintentar
                    </button>
                </div>
            </div>
            
            <!-- Footer -->
            <footer class="mt-8 text-center text-white text-sm" aria-label="Informaci√≥n del pie de p√°gina">
                <p>Villaitue - Sistema de Autoconsultas por voz ¬© VHSN 2026</p>
            </footer>
        </div>
    </div>

    <!-- Indicador de procesamiento accesible -->
    <div 
        id="processingIndicator" 
        role="status" 
        aria-live="polite"
        aria-label="Procesando su solicitud"
    >
        <div class="processing-spinner" aria-hidden="true"></div>
        <div class="processing-text" id="processingMessage">
            <div class="processing-message" data-message="Estoy trabajando para ti...">Estoy trabajando para ti...</div>
            <div class="processing-message" data-message="Buscando la mejor informaci√≥n...">Buscando la mejor informaci√≥n...</div>
            <div class="processing-message" data-message="Un momento, por favor...">Un momento, por favor...</div>
            <div class="processing-message" data-message="Analizando tu solicitud...">Analizando tu solicitud...</div>
        </div>
    </div>

    <!-- Leaflet JS para OpenStreetMap -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        // Variables globales
        let recognition = null;
        let isListening = false;
        let welcomeInterval = null;
        let welcomeSlideIndex = 0;
        let currentCarouselIndex = 0;
        let carouselInterval = null;
        let carouselSlides = [];
        let carouselDots = [];
        let map = null;
        let marker = null;
        let processingMessages = [];
        let currentMessageIndex = 0;
        let messageInterval = null;
        let autoResetTimeout = null; // Para el temporizador de 10 segundos
        
        // ‚úÖ COORDENADAS CORRECTAS Y PRECISAS DE GOOGLE MAPS
        const VILLAITUE_COORDS = [-39.2852346, -72.2227348];
        const MAP_ZOOM = 17;
        const AUTO_RESET_TIMEOUT_MS = 10000; // 10 segundos
        
        // Funci√≥n para anunciar mensajes a lectores de pantalla
        function announceToScreenReader(message) {
            const srRegion = document.getElementById('sr-only-region');
            srRegion.textContent = message;
            setTimeout(() => srRegion.textContent = '', 1000);
        }
        
        // Inicializar mensajes de procesamiento
        function initProcessingMessages() {
            const messageElements = document.querySelectorAll('.processing-message');
            processingMessages = Array.from(messageElements).map(el => el.dataset.message);
            if (messageElements.length > 0) {
                messageElements[0].style.display = 'block';
            }
            if (processingMessages.length > 1) {
                messageInterval = setInterval(() => {
                    messageElements.forEach(el => el.style.display = 'none');
                    currentMessageIndex = (currentMessageIndex + 1) % processingMessages.length;
                    messageElements[currentMessageIndex].style.display = 'block';
                    announceToScreenReader(processingMessages[currentMessageIndex]);
                }, 3000);
            }
        }
        
        // Mostrar/Ocultar indicador de procesamiento
        function showProcessingIndicator() {
            document.getElementById('processingIndicator').style.display = 'flex';
            announceToScreenReader("Procesando su solicitud. Por favor, espere.");
        }
        
        function hideProcessingIndicator() {
            document.getElementById('processingIndicator').style.display = 'none';
        }
        
        // Inicializar carrusel de fondo
        function initWelcomeCarousel() {
            const slides = document.querySelectorAll('.welcome-slide');
            if (slides.length === 0) return;
            
            welcomeInterval = setInterval(() => {
                welcomeSlideIndex = (welcomeSlideIndex + 1) % slides.length;
                slides.forEach((slide, index) => {
                    slide.classList.toggle('active', index === welcomeSlideIndex);
                });
            }, 3000);
        }
        
        // Inicializar reconocimiento de voz
        function initVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                announceToScreenReader("Su navegador no soporta reconocimiento de voz. Por favor, use Chrome.");
                return null;
            }
            
            recognition = new SpeechRecognition();
            recognition.lang = 'es-CL';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onstart = () => {
                isListening = true;
                updateVoiceButton(true);
                announceToScreenReader("Escuchando. Puede hablar ahora.");
                // Limpiar cualquier timeout de reinicio anterior
                if (autoResetTimeout) {
                    clearTimeout(autoResetTimeout);
                    autoResetTimeout = null;
                }
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                // ‚úÖ Cancelar el timeout de reinicio YA QUE HUBO ENTRADA DEL USUARIO
                if (autoResetTimeout) {
                    clearTimeout(autoResetTimeout);
                    autoResetTimeout = null;
                }
                announceToScreenReader(`Ha dicho: ${transcript}. Procesando...`);
                sendToN8N(transcript);
            };
            
            recognition.onerror = (event) => {
                isListening = false;
                updateVoiceButton(false);
                const errorMsg = "Error en el reconocimiento de voz";
                showErrorState(errorMsg);
                announceToScreenReader(errorMsg);
                // No hacemos nada con el temporizador aqu√≠.
            };
            
            recognition.onend = () => {
                isListening = false;
                updateVoiceButton(false);
                // No iniciamos el temporizador aqu√≠.
                // Nuestro temporizador ya fue iniciado al activar el micr√≥fono.
            };
            
            return recognition;
        }
        
        // Actualizar bot√≥n de voz
        function updateVoiceButton(listening) {
            const voiceBtn = document.getElementById('voiceControlBtn');
            const voiceIcon = document.getElementById('voiceIcon');
            const startBtn = document.getElementById('startVoiceBtn');
            
            if (listening) {
                voiceBtn.classList.add('listening');
                voiceBtn.classList.add('bg-red-600');
                voiceIcon.classList.add('fa-stop');
                startBtn?.classList.add('listening');
                startBtn?.classList.add('bg-red-600');
            } else {
                voiceBtn.classList.remove('listening');
                voiceBtn.classList.remove('bg-red-600');
                voiceIcon.classList.remove('fa-stop');
                startBtn?.classList.remove('listening');
                startBtn?.classList.remove('bg-red-600');
            }
        }
        
        // Enviar consulta a n8n
        async function sendToN8N(pregunta) {
            showProcessingIndicator();
            
            try {
                const response = await fetch("https://apps.villaitue.cl/webhook/autoservicio", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pregunta: pregunta })
                });
                
                const data = await response.json();
                hideProcessingIndicator();
                
                if (document.startViewTransition) {
                    document.startViewTransition(() => {
                        mostrarRespuestaAgente(data);
                    });
                } else {
                    mostrarRespuestaAgente(data);
                }
                
            } catch (error) {
                hideProcessingIndicator();
                const errorMsg = "Error de conexi√≥n con el servidor";
                showErrorState(errorMsg);
                announceToScreenReader(errorMsg);
            }
        }
        
        // Procesar respuesta
        function processResponse(data) {
            if (Array.isArray(data) && data.length > 0) {
                const item = data[0];
                return {
                    output: item.output || item.msg || "Respuesta recibida",
                    descripcion: item.descripcion || item.description || "Resultado",
                    imagenes: item.imagenes || item.images || [],
                    tipo_plantilla: item.tipo_plantilla || "texto",
                    precio: item.precio || null,
                    caption: item.caption || item.descripcion_imagen || ""
                };
            }
            
            return {
                output: "No se encontraron resultados",
                descripcion: "Sin resultados",
                imagenes: [],
                tipo_plantilla: "texto",
                precio: null,
                caption: ""
            };
        }
        
        // Mostrar respuesta
        function mostrarRespuestaAgente(rawData) {
            const datos = processResponse(rawData);
            document.getElementById('descripcionTitle').textContent = datos.descripcion;
            document.getElementById('outputContent').textContent = datos.output + (datos.precio ? `\n\nPrecio: ${datos.precio}` : '');
            
            // Anunciar la respuesta principal
            announceToScreenReader(`Respuesta: ${datos.descripcion}`);
            
            // Ocultar todos los contenedores primero
            document.getElementById('carouselContainer').classList.add('hidden');
            document.getElementById('infoImageContainer').classList.add('hidden');
            document.getElementById('mapContainer').classList.add('hidden');
            
            if (datos.tipo_plantilla === 'carrusel' && datos.imagenes.length > 0) {
                mostrarCarrusel(datos.imagenes);
                document.getElementById('carouselContainer').classList.remove('hidden');
                announceToScreenReader("Mostrando galer√≠a de im√°genes");
            } else if (datos.tipo_plantilla === 'respuesta-info' && datos.imagenes.length > 0) {
                mostrarInfoImage(datos.imagenes[0], datos.caption);
                document.getElementById('infoImageContainer').classList.remove('hidden');
                announceToScreenReader("Mostrando infograf√≠a informativa");
            } else if (datos.tipo_plantilla === 'mapa-villaitue') {
                mostrarMapa();
                document.getElementById('mapContainer').classList.remove('hidden');
                announceToScreenReader("Mostrando ubicaci√≥n en el mapa");
            }

            // ‚úÖ CORRECCI√ìN CLAVE: Asegurarse de que la pantalla de respuesta est√© visible
            ensureResponseScreenIsVisible();

            // Leer la respuesta y luego activar escucha autom√°tica
            leerTextoYEscucharAutomaticamente(datos.output);
        }

        // Nueva funci√≥n: Garantiza que la pantalla de respuesta est√© visible
        function ensureResponseScreenIsVisible() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const responseWrapper = document.getElementById('responseWrapper');
            
            if (welcomeScreen.classList.contains('hidden') === false) {
                // Si la pantalla de bienvenida est√° visible, transicionar a la de respuesta
                if (document.startViewTransition) {
                    document.startViewTransition(() => {
                        welcomeScreen.classList.add('hidden');
                        responseWrapper.classList.remove('hidden');
                    });
                } else {
                    welcomeScreen.classList.add('hidden');
                    responseWrapper.classList.remove('hidden');
                }
            }
            // Si ya est√° visible, no hacer nada.
        }
        
        // Nueva funci√≥n: Leer texto y luego activar escucha autom√°tica
        function leerTextoYEscucharAutomaticamente(texto) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(texto);
                utterance.lang = 'es-CL';
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // Cuando termine de hablar, activar el micr√≥fono Y el temporizador
                utterance.onend = () => {
                    announceToScreenReader("Escuchando para su pr√≥xima consulta...");
                    if (recognition) {
                        recognition.start();
                        
                        // ‚úÖ INICIAR EL TEMPORIZADOR DE FORMA ROBUSTA
                        startAutoResetTimer();
                    }
                };
                
                speechSynthesis.speak(utterance);
            } else {
                // Si no hay s√≠ntesis de voz, activar inmediatamente y el temporizador
                if (recognition) {
                    recognition.start();
                    startAutoResetTimer();
                }
            }
        }
        
        // Mostrar imagen √∫nica para respuesta-info
        function mostrarInfoImage(imagenUrl, caption) {
            const infoImage = document.getElementById('infoImage');
            const infoImageCaption = document.getElementById('infoImageCaption');
            
            infoImage.src = imagenUrl;
            infoImage.alt = caption || "Infograf√≠a informativa de Caba√±as Villaitue";
            
            if (caption) {
                infoImageCaption.textContent = caption;
                infoImageCaption.style.display = 'block';
            } else {
                infoImageCaption.style.display = 'none';
            }
            
            infoImage.onerror = function() {
                this.src = 'https://via.placeholder.com/800x400/3b82f6/ffffff?text=Infograf√≠a+no+disponible';
                this.alt = "Infograf√≠a no disponible";
                this.style.objectFit = 'cover';
                infoImageCaption.textContent = "Imagen no disponible";
                infoImageCaption.style.display = 'block';
            };
            
            infoImage.onload = function() {
                this.style.objectFit = 'contain';
            };
        }
        
        // Mostrar mapa de OpenStreetMap
        function mostrarMapa() {
            if (map) {
                map.remove();
                map = null;
                marker = null;
            }
            
            map = L.map('villaitueMap').setView(VILLAITUE_COORDS, MAP_ZOOM);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19,
            }).addTo(map);
            
            const customIcon = L.divIcon({
                className: 'map-marker',
                iconSize: [28, 28],
                iconAnchor: [14, 14],
                popupAnchor: [0, -14]
            });
            
            marker = L.marker(VILLAITUE_COORDS, { icon: customIcon })
                .addTo(map)
                .bindPopup(`
                    <div style="text-align: center; padding: 8px; min-width: 200px;">
                        <strong style="color: #ef4444; font-size: 14px;">
                            <i class="fas fa-cabin" aria-hidden="true"></i> Caba√±as Villaitue
                        </strong><br>
                        <div style="margin: 5px 0; padding: 5px; background: #f8fafc; border-radius: 4px;">
                            <small style="color: #64748b;">
                                <i class="fas fa-map-pin" aria-hidden="true"></i> Villarrica, Chile
                            </small>
                        </div>
                        <div style="font-size: 11px; color: #475569; margin: 3px 0;">
                            <i class="fas fa-globe-americas" aria-hidden="true"></i> Lat: ${VILLAITUE_COORDS[0].toFixed(7)}<br>
                            <i class="fas fa-globe-americas" aria-hidden="true"></i> Lon: ${VILLAITUE_COORDS[1].toFixed(7)}
                        </div>
                        <a href="https://www.google.com/maps/place/Caba%C3%B1as+Villaitue+Villarrica/@-39.2853426,-72.2249986,17z/data=!4m9!3m8!1s0x9614623075b3e52f:0x5d9f2d2671974ee4!5m2!4m1!1i2!8m2!3d-39.2852346!4d-72.2227348!16s%2Fg%2F11bxg08fzb?entry=ttu" 
                           target="_blank" 
                           style="display: inline-block; margin-top: 5px; padding: 4px 12px; background: #3b82f6; color: white; border-radius: 4px; text-decoration: none; font-size: 12px;">
                            <i class="fas fa-directions" aria-hidden="true"></i> C√≥mo llegar (Google Maps)
                        </a>
                    </div>
                `)
                .openPopup();
            
            L.circle(VILLAITUE_COORDS, {
                color: '#ef4444',
                fillColor: '#fca5a5',
                fillOpacity: 0.2,
                radius: 25
            }).addTo(map);
            
            setTimeout(() => {
                map.invalidateSize();
                map.setView(VILLAITUE_COORDS, MAP_ZOOM);
            }, 300);
        }
        
        // Mostrar carrusel
        function mostrarCarrusel(imagenes) {
            const container = document.getElementById('carouselContainer');
            const inner = container.querySelector('.carousel-inner');
            const dotsContainer = container.querySelector('.carousel-dots');
            
            inner.innerHTML = '';
            dotsContainer.innerHTML = '';
            
            if (carouselInterval) {
                clearInterval(carouselInterval);
                carouselInterval = null;
            }
            
            carouselSlides = [];
            carouselDots = [];
            currentCarouselIndex = 0;
            
            imagenes.forEach((img, index) => {
                const slide = document.createElement('div');
                slide.className = `carousel-slide ${index === 0 ? 'active' : ''}`;
                slide.setAttribute('role', 'tabpanel');
                slide.setAttribute('aria-label', `Imagen ${index + 1} de ${imagenes.length}`);
                
                const imgElement = document.createElement('img');
                imgElement.src = img;
                imgElement.alt = `Vista de la caba√±a ${index + 1}`;
                imgElement.loading = 'lazy';
                imgElement.onerror = function() {
                    this.src = 'https://via.placeholder.com/800x400/3b82f6/ffffff?text=Imagen+no+disponible';
                    this.alt = "Imagen no disponible";
                };
                
                slide.appendChild(imgElement);
                inner.appendChild(slide);
                carouselSlides.push(slide);
                
                const dot = document.createElement('button');
                dot.className = `carousel-dot ${index === 0 ? 'active' : ''}`;
                dot.dataset.index = index;
                dot.setAttribute('role', 'tab');
                dot.setAttribute('aria-selected', index === 0);
                dot.setAttribute('aria-label', `Ir a la imagen ${index + 1}`);
                dot.addEventListener('click', () => goToSlide(index));
                dotsContainer.appendChild(dot);
                carouselDots.push(dot);
            });
            
            if (imagenes.length > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'carousel-btn carousel-prev';
                prevBtn.innerHTML = '<i class="fas fa-chevron-left" aria-hidden="true"></i>';
                prevBtn.setAttribute('aria-label', 'Imagen anterior');
                prevBtn.addEventListener('click', prevSlide);
                inner.appendChild(prevBtn);
                
                const nextBtn = document.createElement('button');
                nextBtn.className = 'carousel-btn carousel-next';
                nextBtn.innerHTML = '<i class="fas fa-chevron-right" aria-hidden="true"></i>';
                nextBtn.setAttribute('aria-label', 'Siguiente imagen');
                nextBtn.addEventListener('click', nextSlide);
                inner.appendChild(nextBtn);
                
                carouselInterval = setInterval(nextSlide, 5000);
            }
            
            container.classList.remove('hidden');
        }
        
        function goToSlide(index) {
            if (carouselSlides.length === 0) return;
            
            if (index < 0) index = carouselSlides.length - 1;
            if (index >= carouselSlides.length) index = 0;
            
            carouselSlides.forEach(slide => slide.classList.remove('active'));
            carouselSlides[index].classList.add('active');
            
            carouselDots.forEach((dot, i) => {
                const isSelected = i === index;
                dot.classList.toggle('active', isSelected);
                dot.setAttribute('aria-selected', isSelected);
            });
            
            currentCarouselIndex = index;
            
            if (carouselInterval) {
                clearInterval(carouselInterval);
                carouselInterval = setInterval(nextSlide, 5000);
            }
            
            announceToScreenReader(`Mostrando imagen ${index + 1}`);
        }
        
        function nextSlide() {
            const nextIndex = (currentCarouselIndex + 1) % carouselSlides.length;
            goToSlide(nextIndex);
        }
        
        function prevSlide() {
            const prevIndex = (currentCarouselIndex - 1 + carouselSlides.length) % carouselSlides.length;
            goToSlide(prevIndex);
        }
        
        // Mostrar error
        function showErrorState(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('agentResponse').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
        }
        
        // Transici√≥n de inicio a respuesta
        function transitionToResponse() {
            if (document.startViewTransition) {
                document.startViewTransition(() => {
                    document.getElementById('welcomeScreen').classList.add('hidden');
                    document.getElementById('responseWrapper').classList.remove('hidden');
                });
            } else {
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('responseWrapper').classList.remove('hidden');
            }
            announceToScreenReader("Cambiando a la pantalla de respuesta");
        }
        
        // Nueva funci√≥n: Iniciar el temporizador de reinicio autom√°tico - ¬°SIMPLIFICADA!
        function startAutoResetTimer() {
            // Primero, limpiamos cualquier temporizador existente
            if (autoResetTimeout) {
                clearTimeout(autoResetTimeout);
                autoResetTimeout = null;
            }
            
            // Luego, iniciamos uno nuevo
            autoResetTimeout = setTimeout(() => {
                console.log("‚è∞ Temporizador de 10s cumplido. Volviendo a inicio.");
                resetToWelcomeScreen();
            }, AUTO_RESET_TIMEOUT_MS);
            
            console.log("‚è±Ô∏è Temporizador de 10s iniciado.");
        }
        
        // Nueva funci√≥n: Limpia TODO el contenido de la respuesta antes de reiniciar
        function clearResponseContent() {
            console.log("üßπ Limpiando contenido de la respuesta.");
            
            // 1. Limpiar el carrusel
            if (carouselInterval) {
                clearInterval(carouselInterval);
                carouselInterval = null;
            }
            carouselSlides = [];
            carouselDots = [];
            const carouselContainer = document.getElementById('carouselContainer');
            if (carouselContainer) {
                carouselContainer.innerHTML = '';
                carouselContainer.classList.add('hidden');
            }
            
            // 2. Limpiar el mapa
            if (map) {
                map.remove();
                map = null;
                marker = null;
            }
            const mapContainer = document.getElementById('mapContainer');
            if (mapContainer) {
                mapContainer.classList.add('hidden');
            }
            
            // 3. Limpiar la imagen de info
            const infoImageContainer = document.getElementById('infoImageContainer');
            if (infoImageContainer) {
                infoImageContainer.classList.add('hidden');
            }
            
            // 4. Limpiar el texto de la respuesta
            document.getElementById('outputContent').textContent = '';
            document.getElementById('descripcionTitle').textContent = '';
            
            // 5. Asegurarse de que el estado de error est√© oculto
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('agentResponse').classList.remove('hidden');
        }

        // Nueva funci√≥n: Reiniciar a la pantalla de bienvenida - ¬°COMPLETAMENTE LIMPIO!
        function resetToWelcomeScreen() {
            console.log("üîÑ Reiniciando a la pantalla de inicio.");
            
            // 1. Detener el reconocedor de voz si est√° activo
            try {
                if (recognition && isListening) {
                    recognition.stop();
                }
            } catch (e) {
                console.error("Error al detener el reconocedor:", e);
            }
            
            // 2. LIMPIAR TODO EL CONTENIDO ANTES DE CAMBIAR LA VISTA
            clearResponseContent();
            
            // 3. Resetear estados
            isListening = false;
            updateVoiceButton(false);
            
            // 4. Limpiar el temporizador
            if (autoResetTimeout) {
                clearTimeout(autoResetTimeout);
                autoResetTimeout = null;
            }
            
            // 5. FORZAR la transici√≥n visual
            const welcomeScreen = document.getElementById('welcomeScreen');
            const responseWrapper = document.getElementById('responseWrapper');
            
            responseWrapper.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            
            announceToScreenReader("Volviendo a la pantalla de inicio.");
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            initWelcomeCarousel();
            initProcessingMessages();
            recognition = initVoiceRecognition();
            
            // Bot√≥n de inicio
            document.getElementById('startVoiceBtn').addEventListener('click', () => {
                if (recognition) {
                    transitionToResponse();
                    recognition.start();
                }
            });
            
            // Bot√≥n de control de voz
            document.getElementById('voiceControlBtn').addEventListener('click', () => {
                if (!recognition) return;
                if (isListening) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });
            
            // Bot√≥n de nueva consulta
            document.getElementById('newQueryBtn').addEventListener('click', () => {
                if (recognition) recognition.start();
            });
            
            // Bot√≥n de reintento
            document.getElementById('retryBtn').addEventListener('click', () => {
                document.getElementById('errorState').classList.add('hidden');
                document.getElementById('agentResponse').classList.remove('hidden');
                if (recognition) recognition.start();
            });
            
            // Soporte para teclado (Enter para activar micr√≥fono)
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !isListening) {
                    if (recognition) recognition.start();
                }
            });
        });
    </script>
</body>
</html>
