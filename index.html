<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Villa Itue - Autoservicio</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="estilo.css">
</head>
<body>

    <nav class="glass sticky top-0 z-50 p-4 flex items-center justify-between shadow-xl">
        <div class="flex items-center gap-3">
            <div id="status-led" class="w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.6)]"></div>
            <span class="font-black text-2xl tracking-tighter uppercase italic">Villa <span class="text-blue-500">Itue</span></span>
        </div>
        <button id="btn-micro" class="bg-blue-600 p-5 rounded-full shadow-2xl transition-all active:scale-90">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-20a3 3 0 00-3 3v8a3 3 0 006 0V5a3 3 0 00-3-3z"/>
            </svg>
        </button>
    </nav>

    <main id="viewer" class="flex-grow flex items-center justify-center p-6 text-center">
        <div id="welcome" class="fade-in">
            <h1 class="text-5xl font-black italic mb-4">BIENVENIDO</h1>
            <p class="text-slate-400 text-lg">Presione el botón para hablar con Don Atilio.</p>
        </div>
    </main>

    <script>
        // CONFIGURACIÓN - Asegúrate que esta URL sea la de Producción si ya terminaste las pruebas
        const WEBHOOK_URL = 'https://apps.villaitue.cl/webhook-test/autoservicio';
        
        const viewer = document.getElementById('viewer');
        const btn = document.getElementById('btn-micro');
        const led = document.getElementById('status-led');

        // 1. ROTACIÓN DE FONDOS
        const fondos = [
            'https://vsn47925-tech.github.io/img/servicio/portal-entrada.jpg',
            'https://vsn47925-tech.github.io/img/servicio/portal-recep.jpg',
            'https://vsn47925-tech.github.io/img/servicio/portal-villa.jpg'
        ];
        let currentBg = 0;
        function rotateBg() {
            document.body.style.backgroundImage = `linear-gradient(rgba(15, 23, 42, 0.75), rgba(15, 23, 42, 0.75)), url('${fondos[currentBg]}')`;
            currentBg = (currentBg + 1) % fondos.length;
        }
        rotateBg(); setInterval(rotateBg, 15000);

        // 2. SISTEMA DE VOZ (Don Atilio)
        function hablar(texto) {
            if (!texto) return;
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(texto);
            msg.lang = 'es-CL';
            msg.rate = 1.0; 
            window.speechSynthesis.speak(msg);
        }

        // 3. RECONOCIMIENTO DE VOZ
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Speech) {
            alert("Este navegador no soporta reconocimiento de voz. Use Chrome o Edge.");
        }
        const recognition = new Speech();
        recognition.lang = 'es-CL';

        recognition.onstart = () => { 
            btn.classList.add('mic-active'); 
            led.classList.replace('bg-green-500', 'bg-red-500'); 
        };
        
        recognition.onend = () => { 
            btn.classList.remove('mic-active'); 
            led.classList.replace('bg-red-500', 'bg-green-500'); 
        };

        recognition.onresult = async (event) => {
            const query = event.results[0][0].transcript;
            viewer.innerHTML = `<div class="glass p-8 rounded-3xl animate-pulse text-xl font-bold">Don Atilio está consultando...</div>`;
            
            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ query: query })
                });

                if (!response.ok) throw new Error("Error en la respuesta del servidor");

                // Leemos como texto primero para evitar errores de parseo directo
                const textResponse = await response.text();
                let rawData = JSON.parse(textResponse);

                // --- DESEMPAQUETADO DEL JSON (CASOS N8N) ---
                // Caso 1: Viene como Array [ {...} ]
                let data = Array.isArray(rawData) ? rawData[0] : rawData;

                // Caso 2: Viene envuelto en una propiedad 'body' o 'data'
                if (data.body) data = data.body;
                if (data.data && !data.output) data = data.data;

                // Caso 3: El agente mandó un string JSON dentro de 'output'
                if (typeof data.output === 'string' && data.output.trim().startsWith('{')) {
                    try { data = JSON.parse(data.output); } catch(e) {}
                }

                console.log("Datos Finales:", data);

                // ACTIVAR VOZ Y UI
                hablar(data.output || data.descripcion);
                viewer.innerHTML = renderUI(data);

            } catch (err) {
                console.error("Error Crítico:", err);
                viewer.innerHTML = `
                    <div class="glass p-8 rounded-3xl text-red-400">
                        <p class="font-black text-xl mb-2">ERROR DE CONEXIÓN</p>
                        <p class="text-sm opacity-70 italic">No pude conectar con el agente. Revise la consola (F12).</p>
                    </div>`;
            }
        };

        // 4. RENDERIZADO DE LA INTERFAZ
