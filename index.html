const N8N_URL = 'https://apps.villaitue.cl/webhook-test/autoservicio';
        const viewer = document.getElementById('viewer');
        const btn = document.getElementById('btn-micro');
        const led = document.getElementById('status-led');

        // 1. Fondos Dinámicos
        const fotosPortal = [
            'https://vsn47925-tech.github.io/img/servicio/portal-entrada.jpg',
            'https://vsn47925-tech.github.io/img/servicio/portal-recep.jpg',
            'https://vsn47925-tech.github.io/img/servicio/portal-villa.jpg'
        ];
        let bgIdx = 0;
        function updateBg() {
            document.body.style.backgroundImage = `linear-gradient(rgba(15, 23, 42, 0.75), rgba(15, 23, 42, 0.75)), url('${fotosPortal[bgIdx]}')`;
            bgIdx = (bgIdx + 1) % fotosPortal.length;
        }
        updateBg(); setInterval(updateBg, 12000);

        // 2. Voz
        function hablar(texto) {
            if (!texto) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(texto);
            utterance.lang = 'es-CL';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }

        // 3. Reconocimiento y Fetch
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        const rec = new Speech();
        rec.lang = 'es-CL';

        rec.onstart = () => { btn.classList.add('mic-active'); led.classList.replace('bg-green-500', 'bg-red-500'); };
        rec.onend = () => { btn.classList.remove('mic-active'); led.classList.replace('bg-red-500', 'bg-green-500'); };

        rec.onresult = async (e) => {
            const query = e.results[0][0].transcript;
            viewer.innerHTML = `<div class="glass p-8 rounded-3xl animate-pulse">Don Atilio está buscando...</div>`;
            
            try {
                const res = await fetch(N8N_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ query })
                });

                // --- TRATAMIENTO DE RESPUESTA ---
                const raw = await res.json();
                console.log("Respuesta de n8n:", raw); // Revisa esto en F12

                // Si n8n responde con un array [{}], tomamos el primer elemento. 
                // Si responde con el objeto directo {}, lo usamos tal cual.
                let data = Array.isArray(raw) ? raw[0] : raw;

                // Si los datos vienen dentro de una propiedad 'data' (común en n8n)
                if (data.data) data = data.data;

                // Si el agente mandó el JSON como texto dentro de 'output'
                if (typeof data.output === 'string' && data.output.trim().startsWith('{')) {
                    try { data = JSON.parse(data.output); } catch(e) {}
                }

                // Ejecución
                hablar(data.output || data.descripcion);
                viewer.innerHTML = renderResponse(data);

            } catch (err) {
                console.error("Error en Fetch:", err);
                viewer.innerHTML = `<div class="glass p-8 rounded-3xl text-red-400">Error: No se pudo conectar con el agente.</div>`;
            }
        };

        function renderResponse(data) {
            // Caso: No hay imágenes o el agente falló
            if (!data || (!data.imagenes || data.imagenes.length === 0)) {
                return `<div class="glass p-8 rounded-3xl max-w-md fade-in text-lg">${data.output || data.descripcion || "Lo siento, no encontré esa información."}</div>`;
            }

            // Caso: Respuesta con Carrusel
            return `
            <div class="flex flex-col gap-4 max-w-md w-full fade-in">
                <div class="glass rounded-[2.5rem] overflow-hidden shadow-2xl relative aspect-video border border-white/20">
                    <div class="carousel-container h-full">
                        ${data.imagenes.map(img => `<div class="slide h-full"><img src="${img}" class="w-full h-full object-cover"></div>`).join('')}
                    </div>
                    <div class="absolute bottom-3 w-full text-center text-[10px] text-white/50 tracking-widest uppercase font-bold">Deslice ➜</div>
                </div>
                <div class="glass p-6 rounded-[2.5rem]">
                    <h3 class="text-2xl font-bold text-blue-400 mb-2">${data.titulo || 'Villa Itue'}</h3>
                    <p class="text-slate-200 text-sm leading-relaxed mb-4">${data.descripcion || ''}</p>
                    <div class="pt-4 border-t border-white/10 flex justify-between items-center">
                        <span class="text-xs uppercase font-bold text-slate-500">Precio</span>
                        <span class="text-xl font-black text-white">${data.precio || 'Consultar'}</span>
                    </div>
                </div>
            </div>`;
        }

        btn.onclick = () => { try { rec.start(); } catch(e) {} };
