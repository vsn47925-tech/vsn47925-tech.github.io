<script>
    const N8N_URL = 'https://apps.villaitue.cl/webhook-test/autoservicio';
    const viewer = document.getElementById('viewer');
    const textDisplay = document.getElementById('transcription');
    const btn = document.getElementById('btn-micro');

    // --- 1. CONFIGURACIÓN DEL FONDO DINÁMICO (PORTAL) ---
    const fotosPortal = [
        'https://vsn47925-tech.github.io/img/servicio/portal-entrada.jpg',
        'https://vsn47925-tech.github.io/img/servicio/portal-recep.jpg',
        'https://vsn47925-tech.github.io/img/servicio/portal-villa.jpg',
        'https://vsn47925-tech.github.io/img/servicio/portal-volcan.jpg'
    ];

    let currentPortal = 0;

    // Función para cambiar el fondo con desvanecimiento (Fade)
    const cambiarFondoPortal = () => {
        const url = fotosPortal[currentPortal];
        document.body.style.backgroundImage = `linear-gradient(rgba(15, 23, 42, 0.75), rgba(15, 23, 42, 0.75)), url('${url}')`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
        document.body.style.backgroundRepeat = 'no-repeat';
        document.body.style.transition = 'background-image 2s ease-in-out'; // Efecto de desvanecimiento
        
        currentPortal = (currentPortal + 1) % fotosPortal.length;
    };

    // Iniciar fondo inmediatamente al cargar
    cambiarFondoPortal();
    // Cambiar cada 8 segundos
    setInterval(cambiarFondoPortal, 8000);

    // --- 2. MOTOR DE CARRUSEL PARA CABAÑAS Y SERVICIOS ---


    // --- 3. RECONOCIMIENTO Y VOZ ---
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'es-ES';

    const hablarDonAtilio = (texto) => {
        window.speechSynthesis.cancel(); // Detiene cualquier voz previa
        const utterance = new SpeechSynthesisUtterance(texto);
        const voces = window.speechSynthesis.getVoices();
        const voz = voces.find(v => v.lang === 'es-CL' || v.lang === 'es-MX') || voces[0];
        
        utterance.voice = voz;
        utterance.pitch = 0.8;
        utterance.rate = 0.85;
        window.speechSynthesis.speak(utterance);
    };

    recognition.onresult = async (event) => {
        const query = event.results[0][0].transcript;
        textDisplay.innerText = `Usted: "${query}"`;
        
        try {
            const response = await fetch(N8N_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });

            let data = await response.json();
            
            // Si n8n manda el string JSON, lo parseamos (Modo Seguro)
            if (typeof data.output === 'string' && data.output.startsWith('{')) {
                data = JSON.parse(data.output);
            }

            hablarDonAtilio(data.output);
            viewer.innerHTML = renderizarCarrusel(data);

        } catch (error) {
            console.error("Error en comunicación:", error);
        }
    };

    btn.onclick = () => { try { recognition.start(); } catch(e) {} };
    window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
</script>
