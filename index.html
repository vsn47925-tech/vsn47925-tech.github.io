<script>
    const N8N_URL = 'https://apps.villaitue.cl/webhook-test/autoservicio';
    const viewer = document.getElementById('viewer');
    const textDisplay = document.getElementById('transcription');
    const btn = document.getElementById('btn-micro');

    // --- 1. CONFIGURACIÓN DEL FONDO DINÁMICO (PORTAL) ---
    const fotosPortal = [
        'https://vsn47925-tech.github.io/img/servicio/portal-entrada.jpg',
        'https://vsn47925-tech.github.io/img/servicio/portal-recep.jpg',
        'https://vsn47925-tech.github.io/img/servicio/portal-villa.jpg',
        'https://vsn47925-tech.github.io/img/servicio/portal-volcan.jpg'
    ];

    let currentPortal = 0;
    const cambiarFondoPortal = () => {
        const url = fotosPortal[currentPortal];
        document.body.style.backgroundImage = `linear-gradient(rgba(15, 23, 42, 0.75), rgba(15, 23, 42, 0.75)), url('${url}')`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
        document.body.style.transition = 'background-image 2s ease-in-out';
        currentPortal = (currentPortal + 1) % fotosPortal.length;
    };
    cambiarFondoPortal();
    setInterval(cambiarFondoPortal, 8000);

    // --- 2. MOTOR DE CARRUSEL PARA CABAÑAS Y SERVICIOS ---
    const renderizarCarrusel = (datosAgente) => {
        // Extraemos los datos del JSON anidado y del objeto principal
        const infoInterna = JSON.parse(datosAgente.output);
        const titulo = infoInterna.descripcion || "Cabañas Villaitue";
        const precio = datosAgente.precio || "";
        const listaImagenes = datosAgente.imagenes || [];

        // Generamos los slides recorriendo el array de URLs
        const slidesHTML = listaImagenes.map((url, index) => `
            <li>
                <img src="${url}" alt="Imagen ${index + 1}">
                <p class="caption">${precio}</p>
            </li>
        `).join('');

        return `
            <h1 class="main-title">${titulo}</h1>
            <div class="slider">
                <ul>
                    ${slidesHTML}
                </ul>
            </div>
        `;
    };

    // --- 3. RECONOCIMIENTO Y VOZ ---
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'es-ES';

    const hablarDonAtilio = (texto) => {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(texto);
        const voces = window.speechSynthesis.getVoices();
        const voz = voces.find(v => v.lang === 'es-CL' || v.lang === 'es-MX') || voces[0];
        utterance.voice = voz;
        utterance.pitch = 0.8;
        utterance.rate = 0.85;
        window.speechSynthesis.speak(utterance);
    };

    recognition.onresult = async (event) => {
        const query = event.results[0][0].transcript;
        textDisplay.innerText = `Usted: "${query}"`;
        
        try {
            const response = await fetch(N8N_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });

            const resultado = await response.json();
            // n8n suele devolver un array, tomamos el primer elemento
            const data = Array.isArray(resultado) ? resultado[0] : resultado;

            // 1. Parseamos el JSON interno para obtener el texto de voz
            const dataInterna = JSON.parse(data.output);
            
            // 2. Don Atilio habla el "output" del JSON interno
            hablarDonAtilio(dataInterna.output);

            // 3. Renderizamos el carrusel con las imágenes y el precio
            viewer.innerHTML = renderizarCarrusel(data);

        } catch (error) {
            console.error("Error procesando respuesta:", error);
        }
    };

    btn.onclick = () => { try { recognition.start(); } catch(e) {} };
    window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
</script>
